---
title: "UNC_Client"
author: "Simulation"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
chooseCRANmirror(graphics=FALSE, ind=1)
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown
```{r}
##############################################################
############################################################
##########################################################
# --------------------------------
# 0. Load Libraries and Dataset
# --------------------------------
set.seed(123)

pacman::p_load(
  dplyr
  , openxlsx
  , here
  , broom
)

fyc <- readRDS(here::here("data_processed/fyc.RDS"))

fyc <- fyc |> 
  select(-c(
    starts_with("INSCOP"), 
    MARRY31X, MARRY42X, MARRY53X,
    FAMSZE31, FAMSZE42, FAMSZE53)) |> 
  relocate(fct_POVCATYY, .after = POVCATYY)

# --------------------------------
# 1. Design Grid
# --------------------------------
sample_sizes <- c(1000, 2000, 10000)
extreme_props <- c(0.01, 0.05, 0.10)
magnitudes <- c(1, 2, 3)  # 1 = up to $1M, 2 = $2M, 3 = $3M

design_grid <- expand.grid(
  sample_size = sample_sizes,
  extreme_prop = extreme_props,
  magnitude = magnitudes
)

# Define upper bounds for magnitudes
magnitude_bounds <- list(
  "1" = 1e6,
  "2" = 2e6,
  "3" = 3e6
)

# # Mapping for factorial code parts
sample_size_codes <- c("1000" = "1", "2000" = "2", "10000" = "3")
treatments <- c("none", "top99", "top99_mean", "top99_median")
treatment_codes <- c("none" = "1", "top99" = "2", "top99_mean" = "3", "top99_median" = "4")

# Design grid with treatment values: 
design_grid_w_txs <- expand.grid(
  sample_size = sample_sizes,
  extreme_prop = extreme_props,
  magnitude = magnitudes,
  treat = treatments
  ) |> 
  arrange(treat, sample_size, extreme_prop, magnitude)
  
# --------------------------------
# 2. Simulate Datasets
# --------------------------------
sim_results <- list()

for (i in 1:nrow(design_grid)) {
  row <- design_grid[i, ]
  n <- row$sample_size
  p <- row$extreme_prop
  m <- row$magnitude
  upper_bound <- magnitude_bounds[[as.character(m)]]

  # Non-extreme pool: TOTEXPYY < 50,000
  base_pool <- fyc %>% filter(TOTEXPYY < 50000)
 
  # Generate extreme values
  num_extreme <- ceiling(n * p)
  num_normal <- n - num_extreme
  extreme_vals <- runif(num_extreme, min = 50000, max = upper_bound)

  sim_df <- base_pool %>%
    sample_n(num_normal, replace = TRUE) %>%
    mutate(TOTEXPYY = TOTEXPYY) %>%
    bind_rows(
      data.frame(base_pool[1:num_extreme, ], TOTEXPYY = extreme_vals)
    ) %>%
    mutate(
      Sample_Size = n,
      Proportion = paste0(p * 100, "%"),
      Magnitude = m,
      condition = paste0("S", n, "_M", m, "_P", p * 100)
    )

  sim_results[[i]] <- sim_df
}

sim_data_all <- bind_rows(sim_results)

# At this point, should have a list of 27 (3x3x3) because we haven't applied the treatment yet. 
# After applying treatments, should have n=108 datasets (3x3x3x4)

# --------------------------------
# 3. Apply DV Treatment Function
# --------------------------------
apply_treatment <- function(df, treatment) {
  var <- df$TOTEXPYY
  topcut <- quantile(var, 0.99, na.rm = TRUE)
  if (treatment == "none") return(var)
  if (treatment == "top99") return(pmin(var, topcut))
  if (treatment == "top99_mean") {
    mu <- mean(var[var <= topcut], na.rm = TRUE)
    var[var > topcut] <- mu
    return(var)
  }
  if (treatment == "top99_median") {
    med <- median(var[var <= topcut], na.rm = TRUE)
    var[var > topcut] <- med
    return(var)
  }
}

treatments <- c("none", "top99", "top99_mean", "top99_median")

treated_all <- list()

for (t in treatments) {
  treated_df <- sim_data_all %>%
    group_by(condition) %>%
    mutate(
      Treatment = t,
      TOTEXPYY_treated = apply_treatment(cur_data(), t)
    ) %>%
    ungroup()
  treated_all[[t]] <- treated_df
}

treated_all <- bind_rows(treated_all)

# --------------------------------
# 3. Run Simulations
# --------------------------------
results <- list()

for (i in seq_len(nrow(design_grid))) {
  row <- design_grid[i, ]
  n <- row$sample_size
  p <- row$prop
  m <- row$magnitude
  t <- row$treat
  
  multiplier <- ifelse(m == 1, 10, ifelse(m == 2, 25, 50))
  
  sim_df <- fyc %>%
    sample_n(n) %>%
    mutate(
      condition = paste0("S", sample_size_codes[as.character(n)],
                         "_M", m,
                         "_P", p * 100,
                         "_", t),
      Sample_Size = n,
      Magnitude = m,
      Extreme_Prop = paste0(p * 100, "%"),
      Treatment = t
    )
  
  # Inject outliers
  num_extreme <- ceiling(n * p)
  idx_extreme <- sample(1:n, num_extreme)
  sim_df$TOTEXPYY[idx_extreme] <- sim_df$TOTEXPYY[idx_extreme] * multiplier
  
  # Apply DV treatment
  sim_df$TOTEXPYY_mod <- apply_treatment(sim_df$TOTEXPYY, t)
  
  results[[i]] <- sim_df
}

all_sim <- bind_rows(results)

# --------------------------------
# 4. Summarize Results
# --------------------------------
simulated_summary <- all_sim %>%
  group_by(condition, Sample_Size, Magnitude, Extreme_Prop, Treatment) %>%
  summarise(
    `Mean TOTEXPYY` = round(mean(TOTEXPYY_mod, na.rm = TRUE), 2),
    `Median TOTEXPYY` = round(median(TOTEXPYY_mod, na.rm = TRUE), 2),
    `SD TOTEXPYY` = round(sd(TOTEXPYY_mod, na.rm = TRUE), 2),
    `P99 TOTEXPYY` = round(quantile(TOTEXPYY_mod, 0.99, na.rm = TRUE), 2),
    .groups = "drop"
  )

# --------------------------------
# 5. Export Full Summary
# --------------------------------
write.xlsx(simulated_summary,
           "C:/Users/agham/OneDrive/Desktop/simulated_design_output_full.xlsx",
           rowNames = FALSE)

# --------------------------------
# 6. Export Formatted Design File (Matching research_design_20250603.xlsx)
# --------------------------------
formatted_rows <- lapply(1:nrow(simulated_summary), function(i) {
  row <- simulated_summary[i, ]
  ss_code <- sample_size_codes[as.character(row$Sample_Size)]
  mag_code <- as.character(row$Magnitude)
  prop_code <- substr(row$Extreme_Prop, 1, nchar(row$Extreme_Prop) - 1)
  treat_code <- treatment_codes[row$Treatment]
  factorial_code <- paste0(ss_code, mag_code, prop_code, treat_code)
  
  c(paste0(ss_code, " = ", row$Sample_Size),
    mag_code,
    paste0(prop_code, " = ", row$Extreme_Prop),
    factorial_code,
    factorial_code,
    factorial_code,
    factorial_code)
})

# Headers
header1 <- c("", "", "", "Two-part model, treatment of DV:",
             "2 =  Top-coding at 99th percentile",
             "3 = Mean-preserved top-coding at 99th percentile",
             "4 = Median-preserved top-coding at 99th percentile")
header2 <- c("Sample Size", "Magnitude, Extreme Value", "Proportion, extreme value",
             "Combination of Factorial Levels", "", "", "")

final_data <- do.call(rbind, c(list(header1, header2), formatted_rows))
final_df <- as.data.frame(final_data, stringsAsFactors = FALSE)

write.xlsx(final_df,
           "C:/Users/agham/OneDrive/Desktop/simulated_design_output_formatted.xlsx",
           rowNames = FALSE, colNames = FALSE)

# âœ… All Done!

#################################################################
##################################################################
###################################################################

```

