---
title: "Results"
author: "KW"
date: "`r Sys.Date()`"
output: html_document
---

PURPOSE: Chapters 4 and 5. After DGP is run and executed, import what was created there and make tables and plots for chapters. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```



```{r pkgs}
pacman::p_load(
  broom,
  dplyr,
  effectsize,
  forcats,
  # furrr,
  ggforce,
  ggplot2,
  ggrepel,
  glue,
  gt,
  here,
  lubridate,
  purrr,
  readr,
  scales,
  # tibble,
  tidyr)

dt <- lubridate::today()
dir.create("results", showWarnings = FALSE)
dir.create("figures", showWarnings = FALSE)

all_df <- readRDS(here::here("results/all_df_2026-02-05.RDS"))
cov_grid <- read.csv(here::here("results/cov_grid_2026-02-05.csv"))
att_grid <- read.csv(here::here("results/att_grid_2026-02-05.csv"))

```  


##4 FULL-FACTORIAL ANOVA (RQ answers)
```{r}
# ---- Gamma (Part 2 interaction): bias, SE, coverage ----
# all_df_gamma <- all_df %>%
#   dplyr::filter(model == "gamma") %>%
#   dplyr::mutate(
#     n = factor(n),
#     prop_extreme = factor(prop_extreme),
#     magnitude_level = factor(magnitude_level),
#     treatment = factor(treatment),
#     cover_ind = ifelse(is.na(est) | is.na(se), NA_real_,
#                        as.numeric((est - 1.96*se <= true) & (true <= est + 1.96*se)))
#   )

# --- Build replicate-level coverage indicator for the Gamma model ---
all_df_gamma <- all_df %>%
  dplyr::filter(model == "gamma") %>%
  dplyr::mutate(
    cover_ind = dplyr::if_else(
      is.na(est) | is.na(se) | is.na(true),
      NA_real_,
      as.numeric((est - 1.96*se <= true) & (true <= est + 1.96*se))
    ),
    # ensure factors for ANOVA
    n = as.factor(n),
    prop_extreme = as.factor(prop_extreme),
    magnitude_level = as.factor(magnitude_level),
    treatment = forcats::fct_relevel(treatment, "raw","topcode","mean_adj","median_adj","truncate")
  ) %>%
  dplyr::filter(!is.na(cover_ind))    # drop reps where fits failed

saveRDS(all_df_gamma, file = here::here(paste0("results/all_df_gamma_", dt, ".RDS")))
write.csv(all_df_gamma, file = here::here(paste0("results/all_df_gamma_", dt, ".csv")), row.names = FALSE)

# A) factorial ANOVA on gamma bias (rep-level)
aov_gamma_bias <- aov(bias ~ treatment * n * prop_extreme * magnitude_level, data = all_df_gamma)
summary(aov_gamma_bias)
aov_gamma_bias_df <- as.data.frame(summary(aov_gamma_bias)[[1]])
tidy_aov <- tidy(aov_gamma_bias)
write.csv(
  tidy_aov,
  here::here(paste0("results/aov_gamma_bias_", dt, ".csv")))

eta_squared(aov_gamma_bias, partial=TRUE) # for partial eta squared (or general?)

# B) factorial ANOVA on gamma emp SE  (vs model SE, bc emp SE is the SD of the 500 est's of the coefficient, not the average of the model SE's, right?)
summ_grid_gamma <- summ_grid |> filter(model=="gamma")
aov_gamma_emp_se <- aov(
	emp_se ~ treatment * n * prop_extreme * magnitude_level, data = summ_grid_gamma )
summary(aov_gamma_emp_se) 
eta_squared(aov_gamma_emp_se, partial=TRUE) # for partial eta squared (or general?)

# C) coverage: scenario-level proportion (recommended)
# cov_grid <- all_df_gamma %>%
#   group_by(treatment, n, prop_extreme, magnitude_level) %>%
#   summarise(coverage = mean(cover_ind, na.rm = TRUE), .groups = "drop")
# 
# aov_gamma_cov <- aov(coverage ~ treatment * n * prop_extreme * magnitude_level, data = cov_grid)
# summary(aov_gamma_cov)
# eta_squared(aov_gamma_cov, partial=TRUE) 

## ^^ effect size won't run because only one row per. Need to re-do: 


# --- Full factorial at replicate level now has residual df (many reps per cell) ---
aov_gamma_cov_rep <- aov(
  cover_ind ~ treatment * n * prop_extreme * magnitude_level,
  data = all_df_gamma
)

# Sanity check: residual df should be > 0
summary(aov_gamma_cov_rep)[[1]]["Residuals","Df"]

eta_squared(aov_gamma_cov_rep, partial=TRUE) 

# ---- ATT (RQ4): ATT_hat, ATT_bias, and effect size across treatments ----
all_df_att <- all_df %>%
  dplyr::filter(model == "ATT") %>%
  dplyr::mutate(
    n = factor(n),
    prop_extreme = factor(prop_extreme),
    magnitude_level = factor(magnitude_level),
    treatment = factor(treatment)
  )

# ATT_hat across conditions
aov_att_hat <- aov(est ~ treatment * n * prop_extreme * magnitude_level, data = all_df_att)
summary(aov_att_hat)

# ATT_bias across conditions (recommended DV)
aov_att_bias <- aov(bias ~ treatment * n * prop_extreme * magnitude_level, data = all_df_att)
summary(aov_att_bias)

# Effect size (d_est) across conditions (optional but usually helpful)
aov_att_d <- aov(d_est ~ treatment * n * prop_extreme * magnitude_level, data = all_df_att)
summary(aov_att_d)

# Save ANOVA-ready datasets
write.csv(all_df_att, file = here::here(paste0("results/all_df_att_", dt, ".csv")), row.names = FALSE)
write.csv(cov_grid,   file = here::here(paste0("results/cov_grid_", dt, ".csv")), row.names = FALSE)

```  


```{r descr}
# Focus on the Gamma Part-2 interaction (can switch to "ATT" later)
summ_gamma <- summ_grid %>%
  dplyr::filter(model == "gamma") %>%
  dplyr::mutate(
    treatment = forcats::fct_relevel(
      treatment, "raw", "topcode", "mean_adj", "median_adj", "truncate"
    )
  )  

# ---- Bias (overall) ----
# mean_bias is average SIGNED bias; preserves direction of estimator's errors, where neg is systematic underestimation and positive is systematic overestimation and opposing signs are going to cancel each other out. 
# The mean_abs_bias is the average absolute magnitude of the bias, which measures how far the estimator is from the truth on average. Does not allow pos/neg to cancel each other out. Always >=0. Larger values indicate more inconsistent or unstable estimation. 
# Mean_abs_bias captures estimator error magnitude, while mean_bias captures estimator direction. mean_bias answers if treatment method systematically over or under estimates the effect, while mean_abs_bias answers how large are the estimation errors, regardless of direction. A method an have a mean bias of 0 and look good but actually perform poorly when you see a large mean_abs_bias because that means it swings pos in some directions, negative in others. 
tab_gamma_bias_overall <- summ_gamma %>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(
    scenarios      = dplyr::n(),
    mean_bias      = mean(bias, na.rm = TRUE),
    median_bias    = median(bias, na.rm = TRUE),
    mad_bias       = mad(bias, na.rm = TRUE),
    mean_abs_bias  = mean(abs(bias), na.rm = TRUE),
    .groups = "drop"
  )

gt_gamma_bias_overall <- tab_gamma_bias_overall %>%
  dplyr::mutate(
    mean_bias     = scales::number(mean_bias, accuracy = 0.0001),
    median_bias   = scales::number(median_bias, accuracy = 0.0001),
    mad_bias      = scales::number(mad_bias, accuracy = 0.0001),
    mean_abs_bias = scales::number(mean_abs_bias, accuracy = 0.0001)
  ) %>%
  gt::gt() %>%
  gt::tab_header(
    title = "Gamma Interaction — Descriptive Statistics: Bias (All Scenarios)",
    subtitle = "Negative = underestimation; Positive = overestimation"
  ) %>%
  gt::tab_options(data_row.padding = gt::px(1))

# Helper for quantiles (same as before)
q_fun <- function(x, p) stats::quantile(x, probs = p, na.rm = TRUE, type = 7)

tab_bias_full_overall <- summ_gamma %>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(
    scenarios        = dplyr::n(),
    mean_bias        = mean(bias, na.rm = TRUE),
    sd_bias          = sd(bias, na.rm = TRUE),
    median_bias      = median(bias, na.rm = TRUE),
    mad_bias         = mad(bias, na.rm = TRUE),
    min_bias         = min(bias, na.rm = TRUE),
    q1_bias          = q_fun(bias, 0.25),
    q3_bias          = q_fun(bias, 0.75),
    iqr_bias         = q3_bias - q1_bias,
    max_bias         = max(bias, na.rm = TRUE),
    mean_abs_bias    = mean(abs(bias), na.rm = TRUE),
    share_bias_neg   = mean(bias < 0, na.rm = TRUE),
    share_bias_pos   = mean(bias > 0, na.rm = TRUE),
    .groups = "drop"
  )

gt_bias_full_overall <- tab_bias_full_overall %>%
  dplyr::mutate(
    dplyr::across(
      c(mean_bias, sd_bias, median_bias, mad_bias, min_bias, q1_bias, q3_bias, iqr_bias, max_bias, mean_abs_bias),
      ~ scales::number(.x, accuracy = 0.0001)
    ),
    share_bias_neg = scales::percent(share_bias_neg, accuracy = 0.1),
    share_bias_pos = scales::percent(share_bias_pos, accuracy = 0.1)
  ) %>%
  gt::gt() %>%
  gt::tab_header(
    title = "Gamma Interaction — Full Descriptive Statistics: Bias",
    subtitle = "Scenario-level bias (mean signed bias per scenario) summarized across scenarios by treatment"
  ) %>%
  gt::cols_label(
    scenarios      = "N scenarios",
    mean_bias      = "Mean",
    sd_bias        = "SD",
    median_bias    = "Median",
    mad_bias       = "MAD",
    min_bias       = "Min",
    q1_bias        = "Q1",
    q3_bias        = "Q3",
    iqr_bias       = "IQR",
    max_bias       = "Max",
    mean_abs_bias  = "Mean |bias|",
    share_bias_neg = "Share bias < 0",
    share_bias_pos = "Share bias > 0"
  ) %>%
  gt::tab_options(data_row.padding = gt::px(1))

gt_bias_full_overall

# ---- Empirical SE (overall) ----
tab_gamma_empse_overall <- summ_gamma %>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(
    scenarios   = dplyr::n(),
    mean_emp_se = mean(emp_se, na.rm = TRUE),
    sd_emp_se   = sd(emp_se, na.rm = TRUE),
    .groups = "drop"
  )

gt_gamma_empse_overall <- tab_gamma_empse_overall %>%
  dplyr::mutate(
    mean_emp_se = scales::number(mean_emp_se, accuracy = 0.0001),
    sd_emp_se   = scales::number(sd_emp_se, accuracy = 0.0001)
  ) %>%
  gt::gt() %>%
  gt::tab_header(
    title = "Gamma Interaction — Descriptive Statistics: Empirical SE (All Scenarios)",
    subtitle = "Empirical SE = Monte Carlo SD of the estimator across replications"
  ) %>%
  gt::tab_options(data_row.padding = gt::px(1))

# Helper to get quantiles safely
q_fun <- function(x, p) stats::quantile(x, probs = p, na.rm = TRUE, type = 7)

tab_empse_full_overall <- summ_gamma %>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(
    scenarios       = dplyr::n(),
    mean_emp_se     = mean(emp_se, na.rm = TRUE),
    sd_emp_se       = sd(emp_se, na.rm = TRUE),
    median_emp_se   = median(emp_se, na.rm = TRUE),
    mad_emp_se      = mad(emp_se, na.rm = TRUE),
    min_emp_se      = min(emp_se, na.rm = TRUE),
    q1_emp_se       = q_fun(emp_se, 0.25),
    q3_emp_se       = q_fun(emp_se, 0.75),
    iqr_emp_se      = q3_emp_se - q1_emp_se,
    max_emp_se      = max(emp_se, na.rm = TRUE),
    .groups = "drop"
  )

gt_empse_full_overall <- tab_empse_full_overall %>%
  dplyr::mutate(
    dplyr::across(
      c(mean_emp_se, sd_emp_se, median_emp_se, mad_emp_se,
        min_emp_se, q1_emp_se, q3_emp_se, iqr_emp_se, max_emp_se),
      ~ scales::number(.x, accuracy = 0.0001)
    )
  ) %>%
  gt::gt() %>%
  gt::tab_header(
    title = "Gamma Interaction — Full Descriptive Statistics: Empirical SE",
    subtitle = "Scenario-level empirical SE (Monte Carlo SD of the estimator) summarised across scenarios by treatment"
  ) %>%
  gt::cols_label(
    scenarios = "N scenarios",
    mean_emp_se = "Mean",
    sd_emp_se = "SD",
    median_emp_se = "Median",
    mad_emp_se = "MAD",
    min_emp_se = "Min",
    q1_emp_se = "Q1",
    q3_emp_se = "Q3",
    iqr_emp_se = "IQR",
    max_emp_se = "Max"
  ) %>%
  gt::tab_options(data_row.padding = gt::px(1))

gt_empse_full_overall

# ---- Coverage (overall) ----
tab_gamma_cov_overall <- summ_gamma %>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(
    scenarios       = dplyr::n(),
    mean_cov        = mean(coverage, na.rm = TRUE),
    p_cov_below_95  = mean(coverage < 0.95, na.rm = TRUE),
    .groups = "drop"
  )

gt_gamma_cov_overall <- tab_gamma_cov_overall %>%
  dplyr::mutate(
    mean_cov       = scales::percent(mean_cov, accuracy = 0.1),
    p_cov_below_95 = scales::percent(p_cov_below_95, accuracy = 0.1)
  ) %>%
  gt::gt() %>%
  gt::tab_header(
    title = "Gamma Interaction — Descriptive Statistics: Coverage (All Scenarios)",
    subtitle = "Nominal = 95%; table reports mean coverage and share of scenarios < 95%"
  ) %>%
  gt::tab_options(data_row.padding = gt::px(1))

# Stratified tables by prop_extreme * n * magnitude level 
# A tiny formatter for numeric columns
num4 <- function(x) scales::number(x, accuracy = 0.0001)

tab_cov_full_overall <- summ_gamma %>%
  dplyr::group_by(treatment) %>%
  dplyr::summarise(
    scenarios         = dplyr::n(),
    mean_cov          = mean(coverage, na.rm = TRUE),
    sd_cov            = sd(coverage, na.rm = TRUE),
    median_cov        = median(coverage, na.rm = TRUE),
    mad_cov           = mad(coverage, na.rm = TRUE),
    min_cov           = min(coverage, na.rm = TRUE),
    q1_cov            = q_fun(coverage, 0.25),
    q3_cov            = q_fun(coverage, 0.75),
    iqr_cov           = q3_cov - q1_cov,
    max_cov           = max(coverage, na.rm = TRUE),
    # policy-relevant shares around nominal 0.95
    p_cov_below_95    = mean(coverage < 0.95, na.rm = TRUE),
    p_cov_ge_95       = mean(coverage >= 0.95, na.rm = TRUE),
    .groups = "drop"
  )

gt_cov_full_overall <- tab_cov_full_overall %>%
  dplyr::mutate(
    # format coverage fields as percents where appropriate
    dplyr::across(
      c(mean_cov, sd_cov, median_cov, mad_cov, min_cov, q1_cov, q3_cov, iqr_cov, max_cov),
      ~ scales::percent(.x, accuracy = 0.1)
    ),
    p_cov_below_95 = scales::percent(p_cov_below_95, accuracy = 0.1),
    p_cov_ge_95    = scales::percent(p_cov_ge_95, accuracy = 0.1)
  ) %>%
  gt::gt() %>%
  gt::tab_header(
    title = "Gamma Interaction — Full Descriptive Statistics: Coverage",
    subtitle = "Scenario-level coverage summarised across scenarios by treatment (nominal: 95%)"
  ) %>%
  gt::cols_label(
    scenarios = "N scenarios",
    mean_cov = "Mean",
    sd_cov = "SD",
    median_cov = "Median",
    mad_cov = "MAD",
    min_cov = "Min",
    q1_cov = "Q1",
    q3_cov = "Q3",
    iqr_cov = "IQR",
    max_cov = "Max",
    p_cov_below_95 = "Share < 95%",
    p_cov_ge_95    = "Share ≥ 95%"
  ) %>%
  gt::tab_options(data_row.padding = gt::px(1))

gt_cov_full_overall

# Factory that returns a gt table for a given data frame + header labels
make_gt_table <- function(df, title, subtitle) {
  gt::gt(df) |>
    gt::tab_header(title = title, subtitle = subtitle) |>
    gt::tab_options(data_row.padding = gt::px(1))
}

# Split by scenario factors
split_keys <- c("prop_extreme", "n", "magnitude_level")
gamma_groups <- summ_gamma %>% dplyr::group_by(across(all_of(split_keys))) %>% dplyr::group_split()

gt_bias_list <- lapply(gamma_groups, function(g) {
  hdr <- g %>% dplyr::slice(1) %>% dplyr::select(all_of(split_keys))
  sub_lab <- glue::glue("prop_extreme = {hdr$prop_extreme}, n = {hdr$n}, magnitude_level = {hdr$magnitude_level}")

  tab <- g %>%
    dplyr::group_by(treatment) %>%
    dplyr::summarise(
      scenarios      = dplyr::n(),
      mean_bias      = mean(bias, na.rm = TRUE),
      median_bias    = median(bias, na.rm = TRUE),
      mad_bias       = mad(bias, na.rm = TRUE),
      mean_abs_bias  = mean(abs(bias), na.rm = TRUE),
      .groups = "drop"
    ) %>%
    dplyr::mutate(
      mean_bias     = num4(mean_bias),
      median_bias   = num4(median_bias),
      mad_bias      = num4(mad_bias),
      mean_abs_bias = num4(mean_abs_bias)
    )

  make_gt_table(
    tab,
    title = glue::glue("Gamma Interaction — Bias (Stratified)"),
    subtitle = sub_lab
  )
})

gt_empse_list <- lapply(gamma_groups, function(g) {
  hdr <- g %>% dplyr::slice(1) %>% dplyr::select(all_of(split_keys))
  sub_lab <- glue::glue("prop_extreme = {hdr$prop_extreme}, n = {hdr$n}, magnitude_level = {hdr$magnitude_level}")

  tab <- g %>%
    dplyr::group_by(treatment) %>%
    dplyr::summarise(
      scenarios   = dplyr::n(),
      mean_emp_se = mean(emp_se, na.rm = TRUE),
      sd_emp_se   = sd(emp_se, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    dplyr::mutate(
      mean_emp_se = num4(mean_emp_se),
      sd_emp_se   = num4(sd_emp_se)
    )

  make_gt_table(
    tab,
    title = glue::glue("Gamma Interaction — Empirical SE (Stratified)"),
    subtitle = sub_lab
  )
})

gt_cov_list <- lapply(gamma_groups, function(g) {
  hdr <- g %>% dplyr::slice(1) %>% dplyr::select(all_of(split_keys))
  sub_lab <- glue::glue("prop_extreme = {hdr$prop_extreme}, n = {hdr$n}, magnitude_level = {hdr$magnitude_level}")

  tab <- g %>%
    dplyr::group_by(treatment) %>%
    dplyr::summarise(
      scenarios       = dplyr::n(),
      mean_cov        = mean(coverage, na.rm = TRUE),
      p_cov_below_95  = mean(coverage < 0.95, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    dplyr::mutate(
      mean_cov       = scales::percent(mean_cov, accuracy = 0.1),
      p_cov_below_95 = scales::percent(p_cov_below_95, accuracy = 0.1)
    )

  make_gt_table(
    tab,
    title = glue::glue("Gamma Interaction — Coverage (Stratified)"),
    subtitle = sub_lab
  )
})

# Save all stratified tables for appendix
# Ensure output directory exists (you already create "figures" earlier)
if (!dir.exists("figures")) dir.create("figures", showWarnings = FALSE)

# Helper to extract key labels for filenames
label_from_group <- function(g) {
  hdr <- g %>% dplyr::slice(1) %>% dplyr::select(all_of(split_keys))
  paste0("prop", hdr$prop_extreme, "_n", hdr$n, "_mag", hdr$magnitude_level)
}

# Save Bias tables
for (i in seq_along(gt_bias_list)) {
  lab <- label_from_group(gamma_groups[[i]])
  gt::gtsave(gt_bias_list[[i]],
             filename = here::here(paste0("figures/table_bias_", lab, "_", dt, ".png")),
             expand = 0)
}

# Save Empirical SE tables
for (i in seq_along(gt_empse_list)) {
  lab <- label_from_group(gamma_groups[[i]])
  gt::gtsave(gt_empse_list[[i]],
             filename = here::here(paste0("figures/table_empse_", lab, "_", dt, ".png")),
             expand = 0)
}

# Save Coverage tables
for (i in seq_along(gt_cov_list)) {
  lab <- label_from_group(gamma_groups[[i]])
  gt::gtsave(gt_cov_list[[i]],
             filename = here::here(paste0("figures/table_cov_", lab, "_", dt, ".png")),
             expand = 0)
}

## ATT version: For the same stratified tables for ATT (and/or d_est),  replace summ_gamma with summ_att <- summ_grid |> dplyr::filter(model == "ATT") and reuse the same blocks. All required fields were computed earlier in pipeline.

```  



## Over/under estimation  

```{r over_underests}
# Replicate-level indicator of underestimation for gamma model
under_over_scen <- all_df %>%
  dplyr::filter(model == "gamma") %>%
  group_by(treatment, n, prop_extreme, magnitude_level) %>%
  summarise(
    under_rate = mean(est < true, na.rm = TRUE),
    over_rate  = mean(est > true, na.rm = TRUE),
    .groups = "drop"
  )

# Scenario-level merge with your empirical SE and coverage
scenario_stats <- summ_gamma %>%
  left_join(under_over_scen,
            by = c("treatment", "n", "prop_extreme", "magnitude_level")) %>%
  mutate(
    # 'consistently under' if majority of reps are < 0 bias in that scenario
    under_majority = under_rate > 0.5,
    over_majority  = over_rate > 0.5
  )

# Aggregate to treatment-level “consistency” table
tab_consistency <- scenario_stats %>%
  group_by(treatment) %>%
  summarise(
    n_scen = dplyr::n(),
    # scenario-mean bias (your 'bias' already is scenario-level mean bias)
    avg_mean_bias = mean(bias, na.rm = TRUE),
    med_mean_bias = median(bias, na.rm = TRUE),
    share_scen_under = mean(bias < 0, na.rm = TRUE),    # % scenarios with negative mean bias
    share_scen_over  = mean(bias > 0, na.rm = TRUE),
    share_scen_under_majority = mean(under_majority, na.rm = TRUE),
    mean_cov = mean(coverage, na.rm = TRUE),
    mean_emp_se = mean(emp_se, na.rm = TRUE),
    .groups = "drop"
  )

gt_consistency <- tab_consistency %>%
  mutate(
    avg_mean_bias = scales::number(avg_mean_bias, accuracy = 0.0001),
    med_mean_bias = scales::number(med_mean_bias, accuracy = 0.0001),
    share_scen_under = scales::percent(share_scen_under, accuracy = 0.1),
    share_scen_over  = scales::percent(share_scen_over, accuracy = 0.1),
    share_scen_under_majority = scales::percent(share_scen_under_majority, accuracy = 0.1),
    mean_cov = scales::percent(mean_cov, accuracy = 0.1),
    mean_emp_se = scales::number(mean_emp_se, accuracy = 0.0001)
  ) %>%
  gt::gt() %>%
  gt::tab_header(
    title = "Gamma Interaction: Consistency of Under/Over-Estimation by Treatment",
    subtitle = "Share of scenarios with negative mean bias and with majority underestimation"
  )

gt_consistency
```    