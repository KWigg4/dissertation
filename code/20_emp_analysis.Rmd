---
title: "emp analysis"
author: "KW"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(
  dplyr,
  tidyr,
  broom,
  gt,
  MASS
)

meps <- readRDS(here::here("data_processed/fyc_processed.RDS")) 

```


## Empirical Data Analysis  

### Distribution parameters  
 
```{r}
pos_exp <- meps$TOTEXPYY
pos_exp <- pos_exp[pos_exp>0 & !is.na(pos_exp)]

# (fit_gamma <- fitdist(pos_exp, distr = "gamma", method="mme"))  
# fit <- fitdistr(pos_exp, densfun="gamma")

# get shape and scale estimates via Method of Moments
shape_est <- (mean(pos_exp))^2 / var(pos_exp)
scale_est <- var(pos_exp) / mean(pos_exp)

# Basic histogram
hist(pos_exp, breaks = 50, probability = TRUE,
     main = "Histogram of TOTEXPYY",
     xlab = "Expenditure", col = "lightblue", border = "white")

# Add kernel density estimate
lines(density(pos_exp), col = "darkblue", lwd=2)

```  

Formulas used for shape and scale estimates, results: 

 - Shape $\alpha = \frac{\mu^2}{\sigma^2}$ = `r shape_est`  
 - Scale $\theta = \frac{\sigma^2}{\mu}$  = `r scale_est`  

#### Fit and Compare Dns  

```{r}
fit_gamma <- fitdist(pos_exp, "gamma", method = "mme")     # Method of moments
fit_lnorm <- fitdist(pos_exp, "lnorm", method = "mle")     # Maximum likelihood
fit_weibull <- fitdist(pos_exp, "weibull", method = "mle") # Maximum likelihood
gofstat(list(fit_gamma, fit_lnorm, fit_weibull))
```   

```{r}
plot.legend <- c("Gamma", "Lognormal", "Weibull")
denscomp(list(fit_gamma, fit_lnorm, fit_weibull), legendtext = plot.legend)
cdfcomp(list(fit_gamma, fit_lnorm, fit_weibull), legendtext = plot.legend)
qqcomp(list(fit_gamma, fit_lnorm, fit_weibull), legendtext = plot.legend)
```






### zPCS correlation, prepost  

Get prepost correlation for zPCS  

 - First had to average the values where 2 DUPERSID records in pre or post  
 - Pivot wider, count complete cases  

```{r corr_meps}

# 1: Some ids had >1 tp per prepost: 
n_gt1_ids <- meps %>%
  summarise(n = n(), .by = c(DUPERSID, ind_post)) %>%
  filter(n > 1) |> 
	nrow()   # 3797 of 16640!

# 2: Avg the records from multiple dupersids by prepost
zpcs_avg_mult <- meps |> 
  group_by(DUPERSID, ind_post) %>%
  summarise(zPCS42 = mean(zPCS42, na.rm = TRUE), .groups = "drop")

# pivot
zpcs_wide <- zpcs_avg_mult |> 
  pivot_wider(names_from = ind_post, values_from = zPCS42, names_prefix = "zPCS42_") |> 
  mutate(complete_obs = if_else(
    (!is.na(zPCS42_1) & !is.na(zPCS42_0) ), 1, 0
  ))

n_corr_cases <- sum(zpcs_wide$complete_obs)

# 4: Corr
zpcs_corr <- cor(zpcs_wide$zPCS42_0, zpcs_wide$zPCS42_1, use = "complete.obs")
# 0.4302

```  

Results:  

 - N=`r n_corr_cases` complete cases (of `r nrow(z_pcs_wide)`)  
 - Correlation coefficient = `r zpcs_corr`  

### Logit model  

Without random intercept because couldn't get conditional model to converge with random intercept. Do all without.   


```{r logit_noRI}
emp_logit <- glm(
  ind_gt0 ~ ind_post*ind_tx + ind_female + HISPANX + zPCS42, 
  data = meps, 
  family = binomial)

summary(emp_logit)
```  

```{r logit_RI, eval=FALSE}
library(lme4)

emp_logit_mixed <- glmer(
  ind_gt0 ~ ind_post * ind_tx + ind_female + HISPANX + zPCS42 + (1 | DUPERSID),
  data = meps,
  family = binomial
)

summary(emp_logit_mixed)
```


```{r}
# Tidy model output, add odds ratios
(logit_table <- tidy(emp_logit) %>%
  mutate(
    odds_ratio = exp(estimate),
    p.value = round(p.value, 4),
    estimate = round(estimate, 3),
    std.error = round(std.error, 3),
    statistic = round(statistic, 2),
    odds_ratio = round(odds_ratio, 2)
  ))
```


### Gamma model  
Without random intercept / stochastic component for now  


```{r gamma_noRI}

emp_gamma <- glm(
  TOTEXPYY ~ ind_post * ind_tx + ind_female + HISPANX + zPCS42,
  data = meps |> 
    filter(ind_gt0 == 1),
  family = Gamma(link = "log")
)
# Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,  :
#  Model failed to converge with max|grad| = 0.994663 (tol = 0.002, component 1)
# Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,  :
#  Model is nearly unidentifiable: very large eigenvalue
# - Rescale variables?

```  


```{r gamma, eval=FALSE}

emp_gamma_mixed <- glmer(
  TOTEXPYY ~ ind_post * ind_tx + ind_female + HISPANX + zPCS42 + (1 | DUPERSID),
  data = meps |> 
    filter(ind_gt0 == 1),
  family = Gamma(link = "log")
)
# Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,  :
#  Model failed to converge with max|grad| = 0.994663 (tol = 0.002, component 1)
# Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv,  :
#  Model is nearly unidentifiable: very large eigenvalue
# - Rescale variables?

```  

```{r}
(gamma_table <- tidy(emp_gamma) %>%
  mutate(
    exp_coef = exp(estimate),
    p.value = round(p.value, 4),
    estimate = round(estimate, 3),
    std.error = round(std.error, 3),
    statistic = round(statistic, 2),
    exp_coef = round(exp_coef, 2)
  ))
```

