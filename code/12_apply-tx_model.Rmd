---
title: "Apply treatments and Model"
author: "KW"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE)

pacman::p_load(
	dplyr
	, twopartm
)
```  

```{r get_data}
sims <- readRDS(here::here("data_processed/final_sim_data.RDS"))

# without imputed extremes, hoping to see little to no bias
sims_noExt <- readRDS(here::here("data_processed/final_sim_data_noExtreme.RDS"))
```  


```{r sim1}
# untreated dataset 
# p99_sim1 <- quantile(sim1$TOTEXPYY, probs = 0.99)
# p99_sim1_mu <- mean(sim1$TOTEXPYY[sim1$TOTEXPYY > p99_sim1], na.rm=TRUE)
# p99_sim1_med <- median(sim1$TOTEXPYY[sim1$TOTEXPYY > p99_sim1], na.rm=TRUE)

# Create dataset 
fn_apply_tx <- function(sim_id, src) {
  
  # Subset the data frame for the specific sim_id
  # Using .data with the pipe is valid
  .data <- {{src}} |> 
  	# Using !!sim_id to unquote the argument correctly
    filter(sim_id == !!sim_id) |> 
  	# standardize the pcs variable bc it's crazy
  	mutate(zPCS42 = as.vector(scale(PCS42)))
  
  # Dynamically calculate the 99th percentile from the SUBSETTED data
  p99_value <- quantile(.data$TOTEXPYY, probs = 0.99, na.rm = TRUE)
  
  mu_gt99 <- mean(.data[.data > p99_value], na.rm = TRUE)
  med_gt99 <- median(.data[.data > p99_value], na.rm=TRUE)
  
  # Now, create the new variables using the calculated percentile
  df <- .data %>%
    mutate(
      TOTEXPYY_a = ifelse(TOTEXPYY > p99_value, p99_value, TOTEXPYY),
      TOTEXPYY_b = ifelse(TOTEXPYY > p99_value, mu_gt99, TOTEXPYY),
      TOTEXPYY_c = ifelse(TOTEXPYY > p99_value, med_gt99, TOTEXPYY)
    )
  
  return(df)
}

sim1 <- fn_apply_tx(sim_id=1, src=sims)
sim2 <- fn_apply_tx(sim_id=2, src=sims)

sim1_noExt <- fn_apply_tx(sim_id=1, src=sims_noExt)
	
```  

```{r}
fn_tpm <- function(sim_ds, dv, sim_list) {
	
	 # Dynamically create the formulas using the `dv` variable
  formula_part1 <- ind_gt0 ~ ind_tx*ind_post + ind_tx + ind_post + ind_female + HISPANX + PCS42 + INSCOV
  formula_part2 <- as.formula(paste0(dv, " ~ ind_tx*ind_post + ind_tx + ind_post+ ind_female + HISPANX + PCS42 + INSCOV"))
  
  # Part 1: Fit the logistic model for the probability of a non-zero outcome
  model_part1 <- glm(
    formula = formula_part1,
    data = sim_ds,
    family = binomial(link = "logit")
  )
  
  # Part 2: Fit the Gamma model for the positive outcomes only
  sim_positive <- sim_ds %>% filter(ind_gt0 == 1)
  
  model_part2 <- glm(
    formula = formula_part2,
    data = sim_positive,
    family = Gamma(link = "log")
  )

	sim_list <- list(
		model_part1 = model_part1,
		model_part2 = model_part2
	)

	return(sim_list)
}


sim1_bl <- fn_tpm(sim_ds=sim1, dv="TOTEXPYY")
sim1a <- fn_tpm(sim_ds=sim1, dv="TOTEXPYY_a")
sim1b <- fn_tpm(sim_ds=sim1, dv="TOTEXPYY_b")
sim1c <- fn_tpm(sim_ds=sim1, dv="TOTEXPYY_c")

sim1_bl_noExt <- fn_tpm(sim_ds=sim1_noExt, dv="TOTEXPYY")

```   

```{r}
emp_coef_p1 <- readRDS(here::here("data_processed/emp_coef_p1.RDS"))
sim1_bl_noExt$model_part1$coefficients

```



```{r}
emp_coef_p2 <- readRDS(here::here("data_processed/emp_coef_p2.RDS"))
```  

```{r}
sim1_untreated_v2$model_part2$coefficients
```












